<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HsuDDfps 麥塊伺服器狀態</title>
  <link rel="icon" href="Minecraft_Icon.png" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg: #f2efff;
      --bg-accent: #e6e1ff;
      --glass: rgba(255,255,255,0.6);
      --text: #221a39;
      --muted: #b9b2d3;
      --primary: #b9a7ff;
      --primary-strong:#7f69ff;
      --ok: #2ecc71;
      --bad:#ff5c7a;
      --warn:#f1c40f;
      --chip:#e9e4ff;
      --shadow: 0 20px 60px rgba(95,67,200,.15);
      --radius: 18px;
      --card-bg: rgba(40, 30, 70, 0.78); /* 深紫灰半透明 */
      --box-bg:  rgba(20, 15, 40, 0.62); /* 更深的玻璃色 */
      --box-title: #d5d0ff;              /* 小標題淡紫 */
      --body-text: #ffffff;              /* 卡片內文字 */
    }
    *{box-sizing:border-box}
    html,body{
      height:100%; margin:0;
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI",
       "Noto Sans TC","PingFang TC","Microsoft JhengHei", Roboto, "Helvetica Neue", Arial, sans-serif;
      color:var(--text);
      background: var(--bg) no-repeat center/cover fixed url('Index_BG.png');
    }
    .backdrop{position:fixed; inset:0; background:linear-gradient(180deg,rgba(255,255,255,.35),rgba(255,255,255,.2)); backdrop-filter:blur(6px)}
    .page{position:relative; min-height:100%; display:grid; place-items:center; padding:24px}

    /* HUD */
    .hud{
      position:fixed; top:18px; left:18px; right:18px;
      display:flex; justify-content:space-between; gap:12px;
      opacity:0; transform:translateY(-8px);
      animation:fadeDown .7s ease .15s forwards;
    }
    .pill{
      padding:10px 14px; border-radius:999px;
      background: rgba(30,26,55,.55);
      border:1px solid rgba(127,105,255,.35);
      box-shadow: var(--shadow);
      display:flex; align-items:center; gap:10px;
      color:#f1efff;
    }
    .label{ opacity:.85; font-weight:600; letter-spacing:.3px }
    .time{ font-variant-numeric: tabular-nums; font-weight:800 }

    /* 主卡片（已加深） */
    .card{
      width:min(920px,100%);
      background: var(--card-bg);
      border:1px solid rgba(127,105,255,.35);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:26px;
      transform:translateY(16px) scale(.985);
      opacity:0; animation:rise .8s cubic-bezier(.2,.75,.2,1) .1s forwards;
      color: var(--body-text);  /* 內文白色 */
    }

    .head{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px dashed rgba(190,180,255,.35);
      padding-bottom:18px; margin-bottom:18px
    }
    .title{ display:flex; align-items:center; gap:14px }
    .dot{ width:12px; height:12px; border-radius:50% }
    .status{
      display:flex; align-items:center; gap:10px;
      padding:8px 12px; border-radius:999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(190,180,255,.35);
      font-weight:700; letter-spacing:.3px; color:#fff;
    }
    .srv{ font-size:1.25rem; font-weight:800; letter-spacing:.3px; color:#fff }
    .muted{ color: #d7d3ee }

    .grid{ display:grid; gap:14px; grid-template-columns:repeat(12,1fr) }

    /* 子區塊（已加深） */
    .box{
      background: var(--box-bg);
      border:1px solid rgba(127,105,255,.35);
      border-radius:14px;
      padding:16px; min-height:60px; color:#fff;
    }
    .box h4{
      margin:0 0 6px; font-size:.9rem;
      color: var(--box-title); font-weight:700; letter-spacing:.4px
    }
    .motd{ line-height:1.65; word-break:break-word }
    .big{ font-size:1.4rem; font-weight:800; letter-spacing:.4px; font-variant-numeric:tabular-nums }
    .row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }

    .btn{
      appearance:none; border:none; cursor:pointer;
      padding:10px 14px; border-radius:12px;
      font-weight:800; letter-spacing:.3px;
      background:linear-gradient(180deg,var(--primary),var(--primary-strong));
      color:#fff; box-shadow:0 10px 30px rgba(127,105,255,.35)
    }
    .btn:active{ transform: translateY(1px) }
    .btn.ghost{
      background: transparent; color:#c8c2ff;
      border: 2px solid rgba(200,194,255,.85); box-shadow:none
    }

    .ip{
      padding:8px 12px; border-radius:10px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(200,194,255,.35);
      color:#fff; font-variant-numeric: tabular-nums; font-weight:700
    }

    .footer{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-top:16px; color:#e7e5ff
    }
    .tiny{ font-size:.9rem }
    .spinner{
      width:16px; height:16px; border-radius:50%;
      border: 2px solid rgba(200,194,255,.35);
      border-top-color: var(--primary-strong);
      animation: spin .9s linear infinite;
    }
    .ok{ background: rgba(46, 204, 113, .12) !important; border-color: rgba(46,204,113,.35) !important }
    .bad{ background: rgba(255, 92, 122, .12) !important; border-color: rgba(255,92,122,.35) !important }

    @keyframes rise{to{transform:none; opacity:1}}
    @keyframes fadeDown{to{transform:none; opacity:1}}
    @keyframes spin{to{transform:rotate(360deg)}}

    @media (max-width:720px){ .grid{ grid-template-columns: repeat(6, 1fr) } }
  </style>
</head>
<body>
  <div class="backdrop" aria-hidden="true"></div>
  <div class="page">
    <!-- HUD：現在時間 / 上次更新 -->
    <div class="hud">
      <div class="pill"><span class="label">現在時間</span><span id="now" class="time">—</span></div>
      <div class="pill"><span class="label">上次更新</span><span id="last" class="time">—</span></div>
    </div>

    <main class="card" id="card">
      <header class="head">
        <div class="title">
          <div id="statusDot" class="dot" style="background: var(--warn)"></div>
          <div>
            <div class="srv" id="serverName">—</div>
            <div class="muted tiny">mc.hsuddfps.com</div>
          </div>
        </div>
        <div class="status" id="statusBadge">
          <div class="spinner" id="spin"></div>
          <span id="statusText">查詢中…</span>
        </div>
      </header>

      <section class="grid" aria-live="polite" aria-busy="true">
        <div class="box" style="grid-column: span 12">
          <h4>伺服器 MOTD</h4>
          <div id="motd" class="motd">—</div>
        </div>

        <div class="box ok" style="grid-column: span 6" id="playersBox">
          <h4>在線人數</h4>
          <div class="big"><span id="players">—</span></div>
        </div>

        <div class="box" style="grid-column: span 6">
          <h4>IP 位址</h4>
          <div class="row">
            <code class="ip" id="ipText">mc.hsuddfps.com</code>
            <button class="btn" id="copyBtn" type="button">複製IP位址</button>
          </div>
        </div>

        <div class="box" style="grid-column: span 12">
          <h4>玩家列表</h4>
          <div id="playerList" class="tiny muted">—</div>
        </div>
      </section>

      <div class="footer">
        <div class="row tiny">
          <span>資料來源：</span>
          <a class="btn ghost tiny" href="https://api.mcsrvstat.us/2/mc.hsuddfps.com" target="_blank" rel="noopener">mcsrvstat.us v2</a>
        </div>
        <div class="row tiny">
          <span id="refreshState" class="muted">每 30 秒自動更新</span>
          <button class="btn ghost tiny" id="refreshBtn" type="button" title="立即重新整理">手動更新</button>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ===== 可調整參數 =====
    const HOST = "mc.hsuddfps.com";
    const API  = `https://api.mcsrvstat.us/2/${HOST}`; // 使用 v2（與你原本一致）
    const REFRESH_MS = 30_000; // 仍為 30 秒；若常被限流可改 60_000
    const TIMEZONE = "Asia/Taipei";

    // ===== 時間格式 YYYY/MM/DD HH:MM =====
    const fmt = new Intl.DateTimeFormat("zh-Hant", {
      timeZone: TIMEZONE, year: "numeric", month: "2-digit", day: "2-digit",
      hour: "2-digit", minute: "2-digit", hour12: false
    });
    function formatYMDHM(d){
      const p = fmt.formatToParts(d).reduce((a,x)=> (a[x.type]=x.value,a),{});
      return `${p.year}/${p.month}/${p.day} ${p.hour}:${p.minute}`;
    }

    // ===== DOM =====
    const $ = (s)=>document.querySelector(s);
    const nowEl=$("#now"), lastEl=$("#last");
    const statDot=$("#statusDot"), statTxt=$("#statusText"), spinEl=$("#spin");
    const nameEl=$("#serverName"), motdEl=$("#motd");
    const playersEl=$("#players"), playersBox=$("#playersBox");
    const ipEl=$("#ipText"), listEl=$("#playerList");
    const refreshBtn=$("#refreshBtn"), refreshState=$("#refreshState");
    const copyBtn=$("#copyBtn");

    // 時鐘
    function tick(){ nowEl.textContent = formatYMDHM(new Date()); }
    setInterval(tick,1000); tick();

    // 複製 IP
    copyBtn.addEventListener("click", async ()=>{
      try{
        await navigator.clipboard.writeText(HOST);
        copyBtn.textContent = "已複製！";
        setTimeout(()=> copyBtn.textContent = "複製 IP", 1200);
      }catch{ alert("無法複製，請手動選取。"); }
    });

    // ===== 429 退避（避免再被限流） =====
    let backoffUntil = 0;

    async function fetchStatus(manual=false){
      const nowTs = Date.now();
      if (!manual && nowTs < backoffUntil) return;

      // UI loading
      spinEl.style.display = "inline-block";
      statTxt.textContent = "更新中…";
      refreshBtn.disabled = true;

      try{
        const res = await fetch(API, { cache: "no-store" });
        if (res.status === 429) {
          backoffUntil = Date.now() + 5 * 60 * 1000; // 5 分鐘退避
          throw new Error("rate_limited");
        }
        const data = await res.json();

        // 伺服器名稱（v2：hostname）
        const sName = data.hostname || HOST;
        nameEl.textContent = sName;

        // 狀態
        const online = !!data.online;
        statDot.style.background = online ? "var(--ok)" : "var(--bad)";
        statTxt.textContent = online ? "線上" : "離線";

        // MOTD（v2：motd.html/clean/raw）
        const motdHtml = data.motd?.html?.join("<br>") ?? null;
        if (motdHtml) motdEl.innerHTML = motdHtml;
        else motdEl.textContent = data.motd?.clean?.join("\n") ?? data.motd?.raw?.join("\n") ?? "—";

        // 玩家數
        const count = data.players?.online ?? 0;
        const max   = data.players?.max ?? 0;
        playersEl.textContent = online ? `${count} / ${max || "?"}` : "—";
        playersBox.classList.toggle("ok", online);
        playersBox.classList.toggle("bad", !online);

        // 玩家列表（v2: players.list）
        const list = data.players?.list;
        if (online && Array.isArray(list) && list.length){
          listEl.textContent = list.join(", ");
          listEl.classList.remove("muted");
        }else{
          listEl.textContent = online ? "目前無公開玩家列表" : "伺服器離線";
          listEl.classList.add("muted");
        }

        // IP 顯示 & 更新時間
        ipEl.textContent = HOST;
        lastEl.textContent = formatYMDHM(new Date());
        backoffUntil = 0; // 成功清空退避
      }catch(e){
        statDot.style.background = "var(--warn)";
        statTxt.textContent = (e?.message==="rate_limited") ? "被限流，暫停更新" : "更新失敗";
        motdEl.textContent = "無法取得資料，請稍後再試。";
        playersEl.textContent = "—";
        listEl.textContent = "—";
      }finally{
        spinEl.style.display = "none";
        refreshBtn.disabled = false;
        refreshState.textContent = "每 30 秒自動更新";
      }
    }

    // 手動更新 & 輪詢
    refreshBtn.addEventListener("click", ()=> fetchStatus(true));
    fetchStatus();
    setInterval(fetchStatus, REFRESH_MS);
  </script>
</body>
</html>
